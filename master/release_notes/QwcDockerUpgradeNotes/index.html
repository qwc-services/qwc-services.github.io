<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../../img/favicon.ico" />
    <title>qwc-docker upgrade notes - QWC2 - 2024.01.22-master</title>
    <link rel="stylesheet" href="../../css/theme.css" />
    <link rel="stylesheet" href="../../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css" />
        <link href="../../css/custom.css" rel="stylesheet" />
        <link href="../../css/version-select.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "qwc-docker upgrade notes";
        var mkdocs_page_input_path = "release_notes/QwcDockerUpgradeNotes.md";
        var mkdocs_page_url = null;
      </script>
    
    <script src="../../js/jquery-3.6.0.min.js" defer></script>
    <!--[if lt IE 9]>
      <script src="../../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
      <script>hljs.initHighlightingOnLoad();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../.." class="icon icon-home"> QWC2 - 2024.01.22-master
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption"><span class="caption-text">QWC2</span></p>
              <ul class="current">
                  <li class="toctree-l1"><a class="reference internal" href="../..">Home</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../QuickStart/">Quick start</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="#">General configuration</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../configuration/ThemesConfiguration/">Themes</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../configuration/ViewerConfiguration/">Viewer</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../configuration/ResourcesPermissions/">Resources and permissions</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../configuration/ServiceConfiguration/">Services</a>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="#">Selected topics</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../topics/Search/">Search</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../topics/FeatureInfo/">Feature info</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../topics/Printing/">Printing</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../topics/Mapinfo/">Map info</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../topics/Editing/">Editing</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../topics/Snapping/">Snapping</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../topics/TimeManager/">Temporal layers</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../topics/LegendGraphics/">Legend graphics</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../topics/Interfacing/">Interfacing with applications</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../topics/MultiTenancy/">Multi-tenancy</a>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../references/">References</a>
                  </li>
                  <li class="toctree-l1 current"><a class="reference internal current" href="#">Version history</a>
    <ul class="current">
                <li class="toctree-l2"><a class="reference internal" href="../ChangeLog/">ChangeLog</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../QWC2UpgradeNotes/">QWC2 upgrade notes</a>
                </li>
                <li class="toctree-l2 current"><a class="reference internal current" href="./">qwc-docker upgrade notes</a>
    <ul class="current">
    </ul>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../UserGuide/">User guide</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../FAQ/">FAQ</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../..">QWC2 - 2024.01.22-master</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../.." class="icon icon-home" alt="Docs"></a> &raquo;</li>
          <li>QWC2 &raquo;</li>
          <li>Version history &raquo;</li>
      <li>qwc-docker upgrade notes</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="20231024-qwc-base-db-rework-2023-lts-2024-lts">2023.10.24 qwc-base-db rework [2023-lts &rarr; 2024-lts]<a class="headerlink" href="#20231024-qwc-base-db-rework-2023-lts-2024-lts" title="Permanent link">&para;</a></h1>
<p>As of 2023.10.24 the QWC base DB image has been reworked as follows:</p>
<ul>
<li>Migrations were moved to the <code>qwc-base-db</code> repository, the <code>qwc-config-db</code> repository is now obsolete.</li>
<li>A new <code>qwc-base-db-migrate</code> image helps migrating dockerized or external config DBs.</li>
<li>Demo data will be initialized by an optional setup script in <code>qwc-docker</code>, the <code>qwc-demo-db</code> repository is now obsolete.</li>
</ul>
<p>To use the new images, replace</p>
<pre><code class="language-yml">  qwc-postgis:
    image: docker.io/sourcepole/qwc-demo-db:&lt;version&gt;
  ...
</code></pre>
<p>with</p>
<pre><code class="language-yml">  qwc-postgis:
    image: sourcepole/qwc-base-db:&lt;pg_version&gt;
    environment:
      POSTGRES_PASSWORD: '' # TODO: Set your postgres password here!
    volumes:
     - ./volumes/db:/var/lib/postgresql/docker
     # If you don't want/need the demo data, you can remove this line
     - ./volumes/demo-data/setup-demo-data.sh:/docker-entrypoint-initdb.d/2_setup-demo-data.sh
    ports:
     - &quot;127.0.0.1:5439:5432&quot;
    healthcheck:
      test: [&quot;CMD-SHELL&quot;, &quot;pg_isready -U postgres&quot;]
      interval: 10s

  qwc-config-db-migrate:
    image: sourcepole/qwc-base-db-migrate:&lt;version&gt;
    volumes:
     - ./pg_service.conf:/tmp/pg_service.conf:ro
    depends_on:
     - qwc-postgis
</code></pre>
<p>in your <code>docker-compose.yml</code>.</p>
<p>Note:</p>
<ul>
<li>It is now mandatory to set your own <code>POSTGRES_PASSWORD</code>.</li>
<li>You can keep your previous <code>volumes/db</code> postgres data folder, but it is recommended to make a backup.</li>
<li>The <code>sourcepole/qwc-base-db</code> images are versioned according to the Postgres major version (i.e. 13, 14, 15, ...).</li>
<li>The <code>sourcepole/qwc-base-db-migrate</code> images are versioned by date (<code>vYYYY.MM.DD</code>)</li>
<li>See the <a href="https://github.com/qwc-services/qwc-base-db"><code>qwc-base-db</code> README</a> for more information.</li>
<li>As of <code>2023.10.24</code> the name of the database was changed to the more generic <code>qwc_services</code> instead of <code>qwc_demo</code>.</li>
</ul>
<h1 id="upgrading-to-qwc-service-images-v20220126">Upgrading to qwc service images v2022.01.26<a class="headerlink" href="#upgrading-to-qwc-service-images-v20220126" title="Permanent link">&para;</a></h1>
<p>The <code>qwc-uwsgi-base</code> images have been changed to allow for configurable UID/GID of the <code>uwsgi</code> process. The default is <code>UID=33</code> and <code>GID=33</code>, you can override it by setting the <code>SERVICE_UID</code> and <code>SERVICE_GID</code> environment variables in <code>docker-compose.yml</code>.</p>
<p>As a consequence, <code>/var/www</code> is not necessarily anymore the home directory of the user wich runs <code>uwsgi</code>, and therefore the <code>qwc-uwsgi-base</code> images now set <code>ENV PGSERVICEFILE="/srv/pg_service.conf"</code>. You'll therefore need to adapt your <code>pg_service.conf</code> volume mounts in your <code>docker-compose.yml</code> to point to that location, i.e.</p>
<pre><code>[...]
- ./pg_service.conf:/srv/pg_service.conf:ro
[...]
</code></pre>
<h1 id="upgrading-to-qwc-config-generator-v20220112">Upgrading to qwc-config-generator-v2022.01.12<a class="headerlink" href="#upgrading-to-qwc-config-generator-v20220112" title="Permanent link">&para;</a></h1>
<ul>
<li><code>scanned_projects_path_prefix</code> has been dropped as a config setting. Instead, <code>qgis_projects_scan_base_dir</code> must be a directory below <code>qgis_projects_base_dir</code>, and the prefix is automatically computed internally.</li>
<li><code>scanned_projects_path_prefix</code> has been added as a config setting as the output path for preprocessed qgis projects. It must be a directory below <code>qgis_projects_base_dir</code> to which the config service is allowed to write.</li>
</ul>
<h1 id="upgrading-from-qwc-service-images-v2021x-to-v20220108-or-later">Upgrading from qwc service images v2021.x to v2022.01.08 or later<a class="headerlink" href="#upgrading-from-qwc-service-images-v2021x-to-v20220108-or-later" title="Permanent link">&para;</a></h1>
<p>Starting with v2022.01.08, the requirements of all services where updated to use Flask-JWT-Extended 4.3.1.</p>
<p>Flask-JWT-4.x changes the JWT format (see <a href="https://flask-jwt-extended.readthedocs.io/en/stable/v4_upgrade_guide/#encoded-jwt-changes-important">4.0.0 Breaking Changes</a>), which can result in QWC Services returning a <code>Missing claim: identity</code> error message.</p>
<p>To avoid this:
* Change your JWT secret key in <code>.env</code>.
* Ensure all services are upgraded to v2022.01.12 or later (if such a version exists). Please omit v2022.01.08 and v2022.01.11.</p>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../QWC2UpgradeNotes/" class="btn btn-neutral float-left" title="QWC2 upgrade notes"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../../UserGuide/" class="btn btn-neutral float-right" title="User guide">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href="../QWC2UpgradeNotes/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../../UserGuide/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script>var base_url = '../..';</script>
    <script src="../../js/theme_extra.js" defer></script>
    <script src="../../js/theme.js" defer></script>
      <script src="../../search/main.js" defer></script>
      <script src="../../js/version-select.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>
